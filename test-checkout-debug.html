<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Depurador de Stripe Checkout</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f7f8f9;
            color: #333;
        }
        h1, h2 {
            color: #4f46e5;
        }
        .section {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border: 1px solid #e5e7eb;
        }
        button {
            background-color: #4f46e5;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background-color: #4338ca;
        }
        button:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
        input, select {
            width: 100%;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #d1d5db;
            margin-bottom: 15px;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0,0,0,0.1);
            border-radius: 50%;
            border-top-color: #4f46e5;
            animation: spin 1s ease infinite;
            margin-left: 10px;
            vertical-align: middle;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        pre {
            background-color: #f1f5f9;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            margin-top: 15px;
            font-size: 14px;
            border: 1px solid #e2e8f0;
        }
        .success {
            background-color: #ecfdf5;
            color: #065f46;
            padding: 12px;
            border-radius: 6px;
            margin-top: 15px;
            border: 1px solid #6ee7b7;
        }
        .error {
            background-color: #fef2f2;
            color: #b91c1c;
            padding: 12px;
            border-radius: 6px;
            margin-top: 15px;
            border: 1px solid #fca5a5;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #e5e7eb;
        }
        .tab {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        .tab.active {
            border-bottom: 2px solid #4f46e5;
            color: #4f46e5;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="section">
        <h1>Depurador de Stripe Checkout</h1>
        <p>Esta ferramenta ajuda a diagnosticar problemas com a integra√ß√£o do Stripe.</p>
    </div>

    <div class="tabs">
        <div class="tab active" data-tab="direct">Testar Edge Function</div>
        <div class="tab" data-tab="logs">Logs de Depura√ß√£o</div>
        <div class="tab" data-tab="config">Configura√ß√µes</div>
    </div>

    <div id="direct-tab" class="tab-content section">
        <h2>Testar fun√ß√£o Edge do Stripe</h2>
        
        <div>
            <label for="priceId">ID do Pre√ßo:</label>
            <select id="priceId">
                <option value="price_1RMD9JRwUl4uJKT1zQX7jua7">Mensal (price_1RMD9JRwUl4uJKT1zQX7jua7)</option>
                <option value="price_1RMDA6RwUl4uJKT1a9E6MCyA">Trimestral (price_1RMDA6RwUl4uJKT1a9E6MCyA)</option>
                <option value="price_1RMDAhRwUl4uJKT1ZPMwEibp">Semestral (price_1RMDAhRwUl4uJKT1ZPMwEibp)</option>
                <option value="price_1RMDBARwUl4uJKT1rzUe9Jay">Anual (price_1RMDBARwUl4uJKT1rzUe9Jay)</option>
                <option value="custom">Personalizado</option>
            </select>
            
            <div id="customPriceContainer" style="display:none;">
                <label for="customPrice">ID de Pre√ßo Personalizado:</label>
                <input type="text" id="customPrice" placeholder="Digite um ID de pre√ßo personalizado">
            </div>
            
            <button id="testDirect">Testar Diretamente</button>
            <button id="clearDirect">Limpar</button>
        </div>
        
        <div id="directResult"></div>
    </div>

    <div id="logs-tab" class="tab-content section" style="display:none;">
        <h2>Logs de Depura√ß√£o</h2>
        <p>Neste painel ser√£o exibidos todos os logs e mensagens de erro geradas durante os testes.</p>
        
        <button id="clearLogs">Limpar Logs</button>
        <pre id="debugLogs">Nenhum log ainda...</pre>
    </div>

    <div id="config-tab" class="tab-content section" style="display:none;">
        <h2>Configura√ß√µes</h2>
        
        <div>
            <label for="endpointUrl">URL da Fun√ß√£o Edge:</label>
            <input type="text" id="endpointUrl" value="https://gyogfvfmsotveacjcckr.supabase.co/functions/v1/stripe-checkout">
        </div>
        
        <div>
            <label for="successUrl">URL de Sucesso:</label>
            <input type="text" id="successUrl" value="">
        </div>
        
        <div>
            <label for="cancelUrl">URL de Cancelamento:</label>
            <input type="text" id="cancelUrl" value="">
        </div>

        <button id="saveConfig">Salvar Configura√ß√µes</button>
        <div id="configResult"></div>
    </div>

    <script>
        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            // Preencher URLs padr√£o
            document.getElementById('successUrl').value = window.location.origin + '?success=true';
            document.getElementById('cancelUrl').value = window.location.origin + '?canceled=true';
            
            // Verificar par√¢metros da URL
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('success')) {
                addLog('‚úÖ Retorno do Stripe: Pagamento processado com sucesso!');
                document.getElementById('directResult').innerHTML = '<div class="success">Checkout conclu√≠do com sucesso!</div>';
            } else if (urlParams.has('canceled')) {
                addLog('‚ö†Ô∏è Retorno do Stripe: Checkout cancelado pelo usu√°rio');
                document.getElementById('directResult').innerHTML = '<div class="error">Checkout cancelado.</div>';
            }
            
            // Mostrar campo customizado se selecionado
            document.getElementById('priceId').addEventListener('change', function() {
                document.getElementById('customPriceContainer').style.display = 
                    this.value === 'custom' ? 'block' : 'none';
            });
        });
        
        // Navega√ß√£o por tabs
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                // Desativar todas as tabs
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
                
                // Ativar a tab clicada
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab + '-tab').style.display = 'block';
            });
        });
        
        // Bot√£o de teste direto
        document.getElementById('testDirect').addEventListener('click', async function() {
            const resultElement = document.getElementById('directResult');
            const button = this;
            const originalText = button.textContent;
            
            // Obter os valores dos campos
            let priceId = document.getElementById('priceId').value;
            if (priceId === 'custom') {
                priceId = document.getElementById('customPrice').value.trim();
                if (!priceId) {
                    resultElement.innerHTML = '<div class="error">Por favor, informe um ID de pre√ßo v√°lido.</div>';
                    return;
                }
            }
            
            const endpointUrl = document.getElementById('endpointUrl').value.trim();
            const successUrl = document.getElementById('successUrl').value.trim();
            const cancelUrl = document.getElementById('cancelUrl').value.trim();
            
            try {
                // Desabilitar bot√£o e mostrar loading
                button.disabled = true;
                button.innerHTML = 'Processando... <span class="loading"></span>';
                resultElement.innerHTML = '<div>Enviando requisi√ß√£o...</div>';
                
                // Log
                addLog(`üöÄ Iniciando teste para ${priceId}`);
                addLog(`üìÆ Enviando para: ${endpointUrl}`);
                
                // Fazer a requisi√ß√£o
                const response = await fetch(endpointUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        price_id: priceId,
                        success_url: successUrl,
                        cancel_url: cancelUrl
                    })
                });
                
                // Log da resposta
                addLog(`üì• Resposta recebida [Status: ${response.status}]`);
                
                // Processar a resposta
                const data = await response.json();
                
                // Log dos dados
                addLog(`üìÑ Dados: ${JSON.stringify(data, null, 2)}`);
                
                if (!response.ok) {
                    resultElement.innerHTML = `
                        <div class="error">
                            <strong>Erro ${response.status}:</strong> ${data.error || 'Erro desconhecido'}
                        </div>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                    return;
                }
                
                if (data.error) {
                    resultElement.innerHTML = `
                        <div class="error">
                            <strong>Erro:</strong> ${data.error}
                        </div>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                    return;
                }
                
                if (data.url) {
                    resultElement.innerHTML = `
                        <div class="success">
                            <strong>Sucesso!</strong> Sess√£o de checkout criada.
                        </div>
                        <p>Session ID: ${data.sessionId}</p>
                        <p>URL de Checkout: ${data.url}</p>
                        <p>
                            <button id="openCheckout">Abrir em Nova Aba</button>
                            <button id="redirectCheckout">Redirecionar</button>
                        </p>
                    `;
                    
                    // Adicionar eventos aos bot√µes
                    document.getElementById('openCheckout').addEventListener('click', () => {
                        window.open(data.url, '_blank');
                    });
                    
                    document.getElementById('redirectCheckout').addEventListener('click', () => {
                        window.location.href = data.url;
                    });
                } else {
                    resultElement.innerHTML = `
                        <div class="error">
                            <strong>Resposta inesperada:</strong> URL n√£o encontrada
                        </div>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                }
            } catch (error) {
                // Log do erro
                addLog(`‚ùå ERRO: ${error.message}`);
                
                resultElement.innerHTML = `
                    <div class="error">
                        <strong>Erro de conex√£o:</strong> ${error.message}
                    </div>
                `;
            } finally {
                // Restaurar bot√£o
                button.disabled = false;
                button.textContent = originalText;
            }
        });
        
        // Bot√£o Limpar resultados
        document.getElementById('clearDirect').addEventListener('click', function() {
            document.getElementById('directResult').innerHTML = '';
        });
        
        // Bot√£o Limpar logs
        document.getElementById('clearLogs').addEventListener('click', function() {
            document.getElementById('debugLogs').textContent = 'Logs limpos...';
        });
        
        // Salvar configura√ß√µes
        document.getElementById('saveConfig').addEventListener('click', function() {
            const result = document.getElementById('configResult');
            result.innerHTML = '<div class="success">Configura√ß√µes salvas com sucesso!</div>';
            setTimeout(() => { result.innerHTML = ''; }, 3000);
        });
        
        // Fun√ß√£o para adicionar logs
        function addLog(message) {
            const logsElement = document.getElementById('debugLogs');
            const timestamp = new Date().toLocaleTimeString();
            logsElement.textContent = `[${timestamp}] ${message}\n${logsElement.textContent}`;
        }
    </script>
</body>
</html> 